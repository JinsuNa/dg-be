name: ë°±ì—”ë“œ ë°°í¬

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: â˜• JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âš™ï¸ Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: ğŸ§¹ Gradleë¡œ í´ë¦° ë¹Œë“œ (ìºì‹œ ì œê±°)
        run: ./gradlew clean build -x test

      - name: ğŸ³ ë„ì»¤í—ˆë¸Œ ë¡œê·¸ì¸
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USER_NAME }}
          password: ${{ secrets.DOCKER_USER_PW }}

      - name: ğŸ”¨ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ (ìºì‹œ ì œê±°)
        run: docker build --no-cache -t ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be .

      - name: ğŸš€ ë„ì»¤ ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be

      - name: â˜ï¸ AWS EC2ì— SSH ì ‘ì† í›„ ë°°í¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_IP }}
          port: 22
          username: ubuntu
          key: ${{ secrets.AWS_KEY }}
          script: |
            timedatectl set-timezone Asia/Seoul

            echo "ğŸ” ê¸°ì¡´ ë„ì»¤ ì •ë¦¬"
            docker-compose down || true
            docker rm -f $(docker ps -aq) || true
            docker rmi -f $(docker images -aq) || true
            docker volume prune -f -y || true
            docker system prune -af || true

            echo "ğŸ§¾ .env íŒŒì¼ ìƒì„±"
            echo "S3_ACCESSKEY=${{ secrets.S3_ACCESSKEY }}" > .env
            echo "S3_SECRETKEY=${{ secrets.S3_SECRETKEY }}" >> .env

            echo "â¬‡ï¸ ì´ë¯¸ì§€ í’€"
            docker pull ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be

            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì¬ë°°í¬"
            docker-compose up -d --force-recreate
